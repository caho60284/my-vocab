<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>My Vocab Ultimate</title>

<style>
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,sans-serif}
body{margin:0;background:#f3f5f9}

header{position:sticky;top:0;background:#fff;padding:14px;box-shadow:0 2px 6px rgba(0,0,0,.08);z-index:10}
h1{margin:0;font-size:22px}
.count{font-size:13px;color:#666;margin-top:2px}

.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
button{border:none;border-radius:10px;padding:10px 12px;font-size:14px}

.import{background:#1e88e5;color:#fff}
.export{background:#6a5acd;color:#fff}
.deleteall{background:#e53935;color:#fff}
.favbtn{background:#f39c12;color:#fff}
.refresh{background:#27ae60;color:#fff}
.pronounce{background:#14b8a6;color:#fff}
.add{background:#e3f2fd}

.search{margin-top:10px;width:100%;padding:12px;border-radius:12px;border:1px solid #ccc;font-size:16px}

main{padding:14px}

.card{background:#fff;border-radius:14px;padding:14px;margin-bottom:12px;position:relative}
.word{font-weight:700;font-size:18px;cursor:pointer}
.pron{color:#26a69a;margin-top:2px}
.meaning{margin-top:2px}
.icons{margin-top:6px}
.icons span{font-size:20px;margin-right:8px}
.star{position:absolute;right:12px;top:12px;font-size:22px;cursor:pointer}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:14px;z-index:99}
.modal-content{background:#fff;border-radius:16px;padding:14px;width:100%;max-width:420px}

.modal-content input,.modal-content textarea{
width:100%;margin-bottom:10px;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px
}

.modal-actions{display:flex;gap:10px;margin-top:6px}
.modal-actions button{flex:1}

.save{background:#1e88e5;color:#fff}
.delete{background:#e53935;color:#fff}
.cancel{background:#bbb}
.audio{background:#2ecc71;color:#fff}

/* waveform */
.waveBtn{position:relative;overflow:hidden}
.wave{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:3px}
.wave span{width:3px;height:10px;background:white;border-radius:2px;animation:wave 1s infinite}
.wave span:nth-child(2){animation-delay:.1s}
.wave span:nth-child(3){animation-delay:.2s}
.wave span:nth-child(4){animation-delay:.3s}
.wave span:nth-child(5){animation-delay:.4s}

@keyframes wave{
0%,100%{height:8px}
50%{height:18px}
}

.recording{background:#3b82f6 !important;color:transparent !important}
</style>
</head>

<body>

<header>
<h1>üìò My Vocab Ultimate</h1>
<div class="count" id="count"></div>

<div class="controls">
<button class="import" onclick="importCSV()">üì• Import</button>
<button class="export" onclick="exportCSV()">üì§ Export</button>
<button class="deleteall" onclick="deleteAll()">üß® Delete All</button>
<button class="favbtn" onclick="toggleFavView()">‚≠ê Favorites</button>
<button class="refresh" onclick="resetView()">üîÑ</button>
<button class="pronounce" onclick="openChecker()">Pronounce</button>
<button class="add" onclick="openModal()">Ôºã</button>
</div>

<input class="search" id="search" placeholder="Search word or meaning..." oninput="render()">
</header>

<main id="list"></main>

<!-- add/edit -->
<div class="modal" id="modal">
<div class="modal-content">
<input id="word" placeholder="Word">
<input id="ipa" placeholder="IPA">
<textarea id="meaning" placeholder="Meaning"></textarea>

<div class="modal-actions">
<button class="audio" onclick="hear()">Hear</button>
<button class="save" onclick="save()">Save</button>
<button class="delete" onclick="del()">Delete</button>
<button class="cancel" onclick="closeModal()">Cancel</button>
</div>
</div>
</div>

<!-- checker -->
<div class="modal" id="checkerModal">
<div class="modal-content">

<div style="display:flex;gap:6px;align-items:center">
  <input id="checkInput" placeholder="Type word..." oninput="loadCheckWord()">
  <button onclick="clearCheck()" style="margin-left:6px">‚Üª</button>
</div>

<div id="checkWord" style="font-size:22px;font-weight:700"></div>
<div id="checkIPA" style="color:#26a69a"></div>
<div id="checkResult"></div>

<div class="modal-actions">
<button class="audio" onclick="hearWord()">Hear</button>

<button id="testBtn" class="save waveBtn" onclick="testWord()">
<span class="label">Test</span>
<div class="wave" id="wave" style="display:none">
<span></span><span></span><span></span><span></span><span></span>
</div>
</button>

<button class="cancel" onclick="closeChecker()">Close</button>
</div>

</div>
</div>

<script>
let data = JSON.parse(localStorage.getItem("vocabData")||"[]")
let editIndex=-1
let showFav=false

function saveData(){localStorage.setItem("vocabData",JSON.stringify(data))}
function render(){
let list=document.getElementById("list")
let q=document.getElementById("search").value.toLowerCase()
list.innerHTML=""

let filtered=data.filter(d=>{
let hit=d.word.toLowerCase().includes(q)||d.meaning.toLowerCase().includes(q)
return showFav?hit&&d.fav:hit
})

filtered.forEach((d,i)=>{
let realIndex=data.indexOf(d)
let card=document.createElement("div")
card.className="card"
card.innerHTML=`
<div class="star" onclick="toggleFav(${realIndex})">${d.fav?"‚òÖ":"‚òÜ"}</div>
<div class="word" onclick="openModal(${realIndex})">${d.word}</div>
<div class="pron">${d.ipa||""}</div>
<div class="meaning">${d.meaning||""}</div>
<div class="icons">
<span onclick="speak('${d.word}')">üîä</span>
</div>
`
list.appendChild(card)
})
document.getElementById("count").innerText=`${filtered.length} items`
}

function openModal(i=-1){
editIndex=i
modal.style.display="flex"
if(i>-1){
word.value=data[i].word
ipa.value=data[i].ipa||""
meaning.value=data[i].meaning||""
}else{
word.value=""
ipa.value=""
meaning.value=""
}
}

function closeModal(){modal.style.display="none"}

function save(){
let w=word.value.trim()
if(!w)return
if(editIndex>-1){
data[editIndex].word=w
data[editIndex].ipa=ipa.value
data[editIndex].meaning=meaning.value
}else{
data.push({word:w,ipa:ipa.value,meaning:meaning.value,fav:false})
}
saveData()
render()
closeModal()
}

function del(){
if(editIndex>-1){
data.splice(editIndex,1)
saveData()
render()
closeModal()
}
}

function deleteAll(){
if(confirm("Delete all?")){
data=[]
saveData()
render()
}
}

function toggleFav(i){
data[i].fav=!data[i].fav
saveData()
render()
}

function toggleFavView(){
showFav=!showFav
render()
}

function resetView(){
showFav=false
search.value=""
render()
}

function speak(t){
let u=new SpeechSynthesisUtterance(t)
u.lang="en-US"
speechSynthesis.speak(u)
}

function importCSV(){
let inp=document.createElement("input")
inp.type="file"
inp.accept=".csv"
inp.onchange=e=>{
let file=e.target.files[0]
let r=new FileReader()
r.onload=ev=>{
let lines=ev.target.result.split(/\r?\n/)
lines.forEach(l=>{
if(!l.trim())return
let c=l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
if(c.length>=3){
data.push({
word:c[0].replace(/(^"|"$)/g,""),
ipa:c[1].replace(/(^"|"$)/g,""),
meaning:c[2].replace(/(^"|"$)/g,""),
fav:c[3]=="1"
})
}
})
saveData()
render()
alert("Import success")
}
r.readAsText(file,"utf-8")
}
inp.click()
}

function exportCSV(){
let csv=data.map(d=>`"${d.word}","${d.ipa||""}","${d.meaning||""}",${d.fav?1:0}`).join("\n")
let blob=new Blob([csv],{type:"text/csv;charset=utf-8;"})
let a=document.createElement("a")
a.href=URL.createObjectURL(blob)
a.download="vocab.csv"
a.click()
}

function openChecker(){checkerModal.style.display="flex";checkInput.focus()}
function closeChecker(){checkerModal.style.display="none"}

async function fetchIndoMeaning(text){
try{
let r=await fetch("https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=id&dt=t&q="+encodeURIComponent(text))
let j=await r.json()
return j[0]?.map(x=>x[0]).join("")||""
}catch{return""}
}

async function fetchEnglishMeaning(text){
try{
let r = await fetch("https://translate.googleapis.com/translate_a/single?client=gtx&sl=id&tl=en&dt=t&q=" + encodeURIComponent(text))
let j = await r.json()
return j[0]?.map(x=>x[0]).join("") || ""
}catch{
return ""
}
}

async function loadCheckWord(){
let raw = checkInput.value.trim()

if(!raw){
  checkWord.innerText=""
  checkIPA.innerText=""
  checkResult.innerHTML=""
  return
}

checkWord.innerText = raw

let indo = await fetchIndoMeaning(raw)
let eng = await fetchEnglishMeaning(raw)

if(indo && indo.toLowerCase() !== raw.toLowerCase()){
  checkResult.innerHTML = "Arti: " + indo
  try{
    let r = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${raw.toLowerCase()}`)
    let j = await r.json()
    let ipa = j[0]?.phonetics?.find(p=>p.text)?.text || ""
    checkIPA.innerText = ipa
  }catch{
    checkIPA.innerText=""
  }
  return
}

if(eng && eng.toLowerCase() !== raw.toLowerCase()){
  checkResult.innerHTML = "English: " + eng
  checkIPA.innerText=""
  return
}

checkResult.innerHTML=""
checkIPA.innerText=""
}

function hearWord(){
if(checkWord.innerText)speak(checkWord.innerText)
}

function testWord(){
if(!checkWord.innerText)return
const btn=document.getElementById("testBtn")
const wave=document.getElementById("wave")
btn.classList.add("recording")
wave.style.display="flex"

const SR=window.SpeechRecognition||window.webkitSpeechRecognition
if(!SR){btn.classList.remove("recording");wave.style.display="none";return}

const recognition=new SR()
recognition.lang="en-US"

recognition.onresult = e => {

  let spoken = (e.results[0][0].transcript || "")
    .toLowerCase()
    .replace(/[^a-z']/g,"")

  let target = (checkWord.innerText || "")
    .toLowerCase()
    .replace(/[^a-z']/g,"")

  if(spoken.includes(target) && target.length>0){
    checkResult.innerHTML="‚úî Correct"
  }else{
    checkResult.innerHTML="‚úñ Wrong"
    hearWord()
  }

  btn.classList.remove("recording")
  wave.style.display="none"
  recognition.stop()
}

recognition.onerror=()=>{
btn.classList.remove("recording")
wave.style.display="none"
}

recognition.onend=()=>{
btn.classList.remove("recording")
wave.style.display="none"
}

recognition.start()
}

function clearCheck(){
  const inp = document.getElementById("checkInput")
  inp.value = ""
  loadCheckWord()
  inp.focus()
}

render()
</script>

</body>
</html>